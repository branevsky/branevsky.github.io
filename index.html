<!DOCTYPE html>
<html>
	<head>
		<style>
			html, body {
				width: 100%;
				height: 100%;
				margin: 0px;
				overflow: hidden;
			}
		</style>
		<script>
			window.onload = function () 
			{
				var debug = true;
				var debugText = "";
				var deviceType = "pc";
				if( /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) 
				{
					deviceType = "mobile";
				}
				debugText += "deviceType=" + deviceType + "-";
				//window.requestAnimationFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.msRequestAnimationFrame||window.oRequestAnimationFrame||function(f){window.setTimeout(f,1e3/60)}}();

				var canvas = document.querySelector('canvas');
				var ctx = canvas.getContext('2d');
				var W = canvas.width = window.innerWidth;
				var H = canvas.height = window.innerHeight;
								
				var ballVelocityX = 15;
				var ballVelocityY;
				
				var directionx = 1;
				var directiony = 1;
				var lastPlayerCollided = 0;
				
				var playerBorder = 10;
				var playerWidth = 40;
				var playerHeight = 200;
				
				var gameStarted = false;
				
				var playerVelocity = 15;
				var playerVely = 0;
				
				var opponentSpeed = 5;
				
				var scorePlayer1 = 0;
				var scorePlayer2 = 0;
				
				var imageObj = new Image();
				imageObj.src = 'imgs/gazeus.png';
				
				var openMenu = false;
				
				canvas.addEventListener("mousedown", doMouseDown, false);
				function doMouseDown(event)
				{
					var posX = event.pageX;
					var posY = event.pageY;
					console.log("event = " + event.pageX + " - " + event.pageY);
					if(openMenu)
					{
						openMenu = false;
						return;
					}
					if(posX > canvas.width - 200 && posX < (canvas.width) && posY > 16 && posY < 51)
					{
						openMenu = true;
					}
					
					if(deviceType == "mobile")
					{
						StartGame();
					}
				}
				
				function handleOrientation(event) 
				{
					var val = 0;
					if(window.innerHeight > window.innerWidth)
					{
						val = (playerVelocity * event.beta/10);
					}
					else
					{
						val = (playerVelocity * -event.gamma/5);
					}
					playerVely = val;
				}
				window.addEventListener("deviceorientation", handleOrientation);
				
				function Ball() 
				{
					this.r = this.radius = 20;
					this.x = canvas.width / 2;
					this.y = canvas.height - this.radius;
					
					this.draw = function(ctx) {
						ctx.fillStyle = 'red';
						ctx.beginPath();
						
						ctx.arc(
							this.x,
							this.y,
							this.radius,
							0,
							Math.PI*2,
							false
						);
						
						ctx.closePath();
						ctx.fill();
					}
				}
				
				var ball = new Ball();
				
				function Player(x, y)
				{
					this.x = x;
					this.y = y;
					
					this.w = playerWidth;
					this.h = playerHeight;
					
					this.draw = function(ctx) 
					{
						ctx.fillStyle = 'blue';
						ctx.beginPath();
						ctx.rect(this.x, this.y, playerWidth, playerHeight);
						ctx.closePath();
						ctx.fill();
					}
				}
				
				var player1 = new Player(playerBorder, canvas.height / 2 - playerHeight/2);
				var player2 = new Player(canvas.width - playerWidth - playerBorder, canvas.height / 2 - playerHeight / 2);
				
				function Menu()
				{
					this.width = 700;
					this.height = 400;
					this.x = (canvas.width/2 - this.width/2);
					this.y = (canvas.height/2 - this.height/2);
					
					this.draw = function(ctx) 
					{
						ctx.beginPath(); 
						ctx.lineWidth = 15;
						ctx.moveTo(this.x,this.y);
						ctx.lineTo(this.x + this.width, this.y);
						ctx.lineTo(this.x + this.width, this.y + this.height);
						ctx.lineTo(this.x, this.y + this.height);
						ctx.lineTo(this.x,this.y);
						ctx.stroke();	
						ctx.fillStyle = 'white';
						ctx.rect(this.x, this.y, this.width, this.height);
						ctx.fill();
						ctx.fillStyle = 'black';
						ctx.font = '48px serif';
						ctx.textAlign = 'center';
						ctx.fillText("Instruções", canvas.width / 2, this.y + 50);
						ctx.font = '30px serif';
						ctx.textAlign = 'left';
						ctx.fillText("Navegador:", this.x + 50, this.y + 120);
						ctx.font = '20px serif';
						ctx.fillText("Aperte espaço para começar e as setas para cima e para baixo para jogar.", this.x + 70, this.y + 150);
						ctx.font = '30px serif';
						ctx.fillText("Mobile:", this.x + 50, this.y + 200);
						ctx.font = '20px serif';
						ctx.fillText("Clique na tela para começar e incline o celular para jogar.", this.x + 70, this.y + 230);
						ctx.font = '30px serif';
						ctx.fillText("Desenvolvedor:", this.x + 50, this.y + 280);
						ctx.font = '20px serif';
						ctx.fillText("Bruno Ranevsky.", this.x + 70, this.y + 310);
						
						console.log(ctx.measureText("Aperte espaço para começar e as setas para cima e para baixo para jogar."));
					}
				}
				
				var menu = new Menu();
				
				(function renderFrame() {
					requestAnimationFrame(renderFrame);
					ctx.clearRect(0, 0, W, H);
					
					if(gameStarted && !openMenu)
					{
						ball.x += ballVelocityX * directionx;
						ball.y += ballVelocityY * directiony;
						
						if (ball.x + ball.radius > canvas.width) 
						{
							ScorePlayer(1);
						}
						if (ball.x - ball.radius < 0)
						{
							ScorePlayer(2);
						}
						if (ball.y + ball.radius > canvas.height || ball.y - ball.radius  < 0) {
							directiony = -directiony;
						}
					
						ball.draw(ctx);
						
						
					
						if(ball.y + ball.radius > player2.y + player2.h/2)
						{
							player2.y += opponentSpeed;
						}
						else if(ball.y - ball.radius < player2.y)
						{
							player2.y -= opponentSpeed;
						}
					
						if(player2.y + player2.h > canvas.height)
						{
							player2.y = canvas.height - player2.h;
						}
						if(player2.y < 0)
						{
							player2.y = 0;
						}
					}
					
					if(playerVely != 0)
					{
						player1.y += playerVely;
					}
					
					if(player1.y + player1.h > canvas.height)
					{
						player1.y = canvas.height - player1.h;
					}
					if(player1.y < 0)
					{
						player1.y = 0;
					}
					
					player1.draw(ctx);
					
					player2.draw(ctx);
					
					var testColidePlayer1 = collideTest(ball, player1);
					var testColidePlayer2 = collideTest(ball, player2);
					var colided = (testColidePlayer1 && lastPlayerCollided != 1) || (testColidePlayer2 && lastPlayerCollided != 2);
					if (colided)
					{
						directionx = -directionx;
						if (playerVely > 0)
						{
							ballVelocityY -= 2;
						}
						if (playerVely < 0)
						{
							ballVelocityY += 2;
						}
						if(testColidePlayer1)
						{
							lastPlayerCollided = 1;
						}
						if(testColidePlayer2)
						{
							lastPlayerCollided = 2;
						}
					}
					
					ctx.font = '48px serif';
					ctx.fillText(scorePlayer1, canvas.width / 2 - 50 - 24, 50);
					ctx.fillText(scorePlayer2, canvas.width / 2 + 50, 50);
					
					ctx.fillText("Menu", canvas.width - 200, 50);
				
					//draw water mark
					ctx.drawImage(imageObj, canvas.width/2 - imageObj.width/2, canvas.height/2 - imageObj.height / 2);
					
					//draw line in the middle
					ctx.beginPath(); 
					ctx.lineWidth = 2;
					ctx.moveTo(canvas.width/2,0);
					ctx.lineTo(canvas.width/2,canvas.height);
					ctx.stroke();		
					
					if(openMenu)
					{
						menu.draw(ctx);
					}
					
					if(debug)
					{
						ctx.fillStyle = 'black';
						ctx.font = '10px serif';
						ctx.fillText(debugText, 50, 50);
						debugText = "";
					}
				}());
				
				function ScorePlayer(num)
				{
					if(num == 1)
					{
						scorePlayer1 += 1;
					}
					if(num == 2)
					{
						scorePlayer2 += 1;
					}
					gameStarted = false;
				}
				
				function StartGame()
				{
					gameStarted = true;
					ball.x = player1.x + player1.w + ball.radius;
					ball.y = player1.y + player1.h/2;
					ballVelocityY = getRandom(-10, 10);
				}
				
				function getRandom(min, max) {
					return Math.random() * (max - min) + min;
				}
				
				function collideTest(circle, rect) {
					var distX = Math.abs(circle.x - rect.x-rect.w/2);
					var distY = Math.abs(circle.y - rect.y-rect.h/2);

					if (distX > (rect.w/2 + circle.r)) { return false; }
					if (distY > (rect.h/2 + circle.r)) { return false; }

					if (distX <= (rect.w/2)) { return true; } 
					if (distY <= (rect.h/2)) { return true; }

					var dx=distX-rect.w/2;
					var dy=distY-rect.h/2;
					return (dx*dx+dy*dy<=(circle.r*circle.r));
				}
				
				if(deviceType == "pc")
				{
					document.addEventListener('keydown', (event) => 
					{
						const keyName = event.key;

						if (keyName === ' ') {
							StartGame();
						}
						if (keyName === 'ArrowUp')
						{
							playerVely = -playerVelocity;
						}
						if (keyName === 'ArrowDown')
						{
							playerVely = playerVelocity;
						}
					});
					
					document.addEventListener('keyup', (event) => 
					{
						const keyName = event.key;

						if ((keyName === 'ArrowUp') || (keyName === 'ArrowDown'))
						{
							playerVely = 0;
						}
					});
				}
			};
		</script>
	</head>
	<body>
		<canvas id="canvas"></canvas>
	</body>
</html>